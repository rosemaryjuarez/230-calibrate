---
title: "Calibrate Sagehen streamflow"
authors: "Rosemary Juarez, Vanessa Salgado, Liane Chen"
date: "2024-04-30"
output: html_document
---
```{r, setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(sensitivity)
library(tidyverse)
library(purrr)
library(ggpubr)
library(here)
```

```{r, read in data}

#--------------------------
#   set working directory
#--------------------------
setwd(here::here())


#--------------------------
#   read in data
#--------------------------
#reading in observed stream flow data
sager = read.table(here("data","sager.txt"), header=T)

#simulated data from multiple model runs
# multiple results - assuming we've run the model for multiple years, each column
# is streamflow for a different parameter set
msage = read.table(here("data","sagerm.txt"), header=T)


#--------------------------
#   preprocessing data
#--------------------------

# add date ton sager
sager = sager %>%
  mutate(date = paste(day,month,year, sep="/"))

#converting to datetime format
sager$date = as.Date(sager$date,"%d/%m/%Y")


#--------------------------
#   sourcing in R scripts
#--------------------------

#Nash-Sutcliffe Efficiency
source("R/nse.R")

#combined performance metric between NSE and relative error
source("R/cper.R")

#relative error between the model and observations
source("R/relerr.R")

#

```

## Assignment Instructions

Part 1: Come up with a combined metric that you think is interesting

-   if you can, try to include at least one metric (as part of your combined metric) that needs to be transformed
-   be creative - you can subset, aggregate, focus only on particular type of years or days
-   think about ecological or human water uses that depend on certain flow conditions


Part II

-   Perform a split-sample calibration on the Sagehen model output (sagerm.txt)
    -   you can decide what years to pick for pre and post calibration
    -   use your performance metric from Part I
-   Find the best and worst parameter set, given your performance metric
-   Graph something about streamflow (e.g daily, mean August, or ?) for the best parameter set
-   Compute and plot how the performance of the model using the best parameter set changed in pre and post calibration periods (that you chose)
-   Add the 'best' parameter set column number number to the quiz linked below (so we can compare how different metrics influence which parameter you pick)
-   Write 2-3 sentences to explain your metric design and comment on model performance based on your metric

Use to Best Parameter (Column) to record your 'best' parameter sets ([GO TO CANVAS FOR THIS TEST](https://ucsb.instructure.com/courses/19594/assignments/240440))

Hand in Rmarkdown and R file with your performance metric


# creating our model metric

For our assignment, we want to observe the time series of **high flow periods** and **peak flow periods** within the "blank river"
as noted in the graph below, we observed that during the year 1977, peak values of high water periods was during the month of April.
```{r}
ggplot(subset(sagerl, wy==1977), aes(date, flow, col=source,
linetype=source))+geom_line()+scale_y_continuous(trans="log")+labs(y="streamflow
mm/day")
```


WE WANT To compute high metrics, so we are switching from compute_lowflowmetrics function and changing the month (8) which is august.

instead of calculating metrics for low flow periods, we want to calculate metrics for high flow periods.

\- tune serues if maximum events and peak stream flow

-   we are going to use april, since it had the
